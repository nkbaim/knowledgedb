---
title: Dockerå…¥é—¨
date: 2021-06-17 21:08:25
permalink: /linux/docker/
categories:
  - Linuxç›¸å…³
tags:
  - docker
  - singularity
---

![](https://cdn.jsdelivr.net/gh/nkbaim/pics//blog/6218810-497a4a23213dd043.jpg)
## ä¸€ã€å¼•è¨€

è½¯ä»¶è¿è¡Œç¯å¢ƒçš„é…ç½®æ˜¯ä¸€ä¸ªå·¨å¤§çš„éš¾é¢˜ï¼
- é¦–å…ˆæ˜¯Linuxç³»ç»Ÿä¸‹è½¯ä»¶çš„å®‰è£…éš¾é¢˜ã€‚Linuxç³»ç»Ÿå®‰è£…è½¯ä»¶ï¼Œç»å¸¸ä¸å¯é¿å…çš„è¦å¯¹æºç è¿›è¡Œé‡æ–°ç¼–è¯‘ã€‚è¿™ä¸ªè¿‡ç¨‹ä¸­éœ€è¦å¤„ç†è½¯ä»¶æ‰€ä¾èµ–åŠ¨æ€åº“ç‰ˆæœ¬ç­‰é—®é¢˜ï¼Œéå¸¸å®¹æ˜“å‡ºé”™ã€‚è¿™å¯¼è‡´è½¯ä»¶å®‰è£…æˆæœ¬è¾ƒé«˜ã€‚

- å…¶æ¬¡ï¼Œå¤æ‚çš„è¿è¡Œå®¹æ˜“å‡ºç°è½¯ä»¶ç‰ˆæœ¬å†²çªé—®é¢˜ï¼Œæ¯”å¦‚ä¸åŒè½¯ä»¶å¯¹pythonç‰ˆæœ¬ï¼Œå¯¹GCCç‰ˆæœ¬çš„ä¾èµ–å†²çªï¼›

- æ­¤å¤–ï¼Œè½¯ä»¶ç‰ˆæœ¬çš„å¿«é€Ÿè¿­ä»£ï¼Œå®¹æ˜“é€ æˆé•¿æœŸé¡¹ç›®ä¸­åˆ†æç¯å¢ƒä¸ä¸€è‡´çš„é—®é¢˜

- æœ€åï¼Œå¥½ä¸å®¹æ˜“å®‰è£…å¥½è¿è¡Œç¯å¢ƒä¹‹åï¼Œçªç„¶æœ‰äº†æ–°çš„è¿è¡Œå¹³å°ï¼Œåˆéœ€è¦è´¹æ—¶è´¹åŠ›çš„é‡æ–°å®‰è£…ï¼Œè¿™å°±å¾ˆå´©æºƒğŸ˜¡ğŸ˜¡

è€Œ**DockeræŠ€æœ¯**å¯ä»¥æœ‰æ•ˆçš„è§£å†³ä¸Šè¿°é—®é¢˜


## äºŒã€Dockerçš„æ€æƒ³

Dockeræ˜¯ä¸€ä¸ªLinuxåº”ç”¨å®¹å™¨å¼•æ“ã€‚

Linuxå®¹å™¨æŠ€æœ¯å¯ä»¥ä¿è¯è¿›ç¨‹çš„ç›¸äº’ç‹¬ç«‹ï¼Œå¯¹äºå®¹å™¨é‡Œé¢çš„è¿›ç¨‹æ¥è¯´ï¼Œå®ƒæ¥è§¦åˆ°çš„å„ç§èµ„æºéƒ½æ˜¯è™šæ‹Ÿçš„ï¼Œä»è€Œå®ç°ä¸åº•å±‚ç³»ç»Ÿçš„éš”ç¦»ã€‚ç”±äºå®¹å™¨æ˜¯è¿›ç¨‹çº§åˆ«çš„ï¼Œç›¸æ¯”è™šæ‹Ÿæœºæœ‰å¾ˆå¤šä¼˜åŠ¿ã€‚

- å¯åŠ¨å¿«: å¯åŠ¨å®¹å™¨ç›¸å½“äºå¯åŠ¨æœ¬æœºçš„ä¸€ä¸ªè¿›ç¨‹ï¼Œè€Œä¸æ˜¯å¯åŠ¨ä¸€ä¸ªæ“ä½œç³»ç»Ÿï¼Œé€Ÿåº¦å¿«å¾ˆå¤šã€‚

- èµ„æºå ç”¨å°‘: å®¹å™¨åªå ç”¨éœ€è¦çš„èµ„æºï¼Œä¸å ç”¨é‚£äº›æ²¡æœ‰ç”¨åˆ°çš„èµ„æºï¼›

- ä½“ç§¯å°: å®¹å™¨åªè¦åŒ…å«ç”¨åˆ°çš„ç»„ä»¶å³å¯ï¼Œè€Œè™šæ‹Ÿæœºæ˜¯æ•´ä¸ªæ“ä½œç³»ç»Ÿçš„æ‰“åŒ…ï¼Œæ‰€ä»¥å®¹å™¨æ–‡ä»¶æ¯”è™šæ‹Ÿæœºæ–‡ä»¶è¦å°å¾ˆå¤šã€‚

## ä¸‰ã€Dockerå¯ä»¥åšä»€ä¹ˆï¼Ÿ

Docker çš„ä¸»è¦ç”¨é€”ï¼Œç›®å‰æœ‰ä¸‰å¤§ç±»ã€‚

- æä¾›è„šæœ¬è¿è¡Œç¯å¢ƒã€‚æ¯”å¦‚ï¼ŒDNAæµ‹åºæ•°æ®çš„åˆ†æç¯å¢ƒã€‚

- æä¾›å¼¹æ€§çš„äº‘æœåŠ¡ã€‚å› ä¸º Docker å®¹å™¨å¯ä»¥éšå¼€éšå…³ï¼Œå¾ˆé€‚åˆåŠ¨æ€æ‰©å®¹å’Œç¼©å®¹ã€‚

- ç»„å»ºå¾®æœåŠ¡æ¶æ„ã€‚é€šè¿‡å¤šä¸ªå®¹å™¨ï¼Œä¸€å°æœºå™¨å¯ä»¥è·‘å¤šä¸ªæœåŠ¡ï¼Œå› æ­¤åœ¨æœ¬æœºå°±å¯ä»¥æ¨¡æ‹Ÿå‡ºå¾®æœåŠ¡æ¶æ„ã€‚


## å››ã€ Dockeræ¦‚å¿µçš„ä¸‰å¤§ç»„ä»¶

- é•œåƒ Imageï¼šé•œåƒæ˜¯ä¸€ä¸ªå¯è¿è¡Œçš„åº”ç”¨ç¨‹åºç¯å¢ƒï¼Œå…¶ä¸­åŒ…å«ä¸€åˆ‡è¿è¡Œè¯¥è½¯ä»¶æ‰€éœ€çš„ä»£ç ã€è¿è¡Œç¯å¢ƒã€åº“ã€ç¯å¢ƒå˜é‡å’Œé…ç½®æ–‡ä»¶ç­‰ã€‚
  
- å®¹å™¨ Container: å®¹å™¨æ˜¯é•œåƒåœ¨å†…å­˜ä¸­çš„ä¸€ä¸ªè¿è¡Œå®ä¾‹ï¼Œä¸€ä¸ªé•œåƒå¯ä»¥æœ‰å¤šä¸ªè¿è¡Œå®ä¾‹ã€‚

- ä»“åº“ Repository: ä»“åº“æ˜¯é•œåƒæ–‡ä»¶çš„å­˜å‚¨åœ°å€ï¼ŒåŒ…æ‹¬è¿œç¨‹ä»“åº“å’Œæœ¬åœ°ä»“åº“ä¸¤ç±»ï¼Œå‰è€…æ¯”å¦‚ [Docker Hub](https://hub.docker.com/), æ˜¯é•œåƒæ–‡ä»¶ä¸Šä¼ ä¸ä¸‹è½½çš„ç½‘å€ã€‚

## äº”ã€Docker å®‰è£…

> å‚è€ƒï¼š[dockerå®‰è£…](https://docs.docker.com/engine/install/centos/)

## å…­ã€è¿è¡ŒDockeré•œåƒ
```bash
Usage:	docker run [OPTIONS] IMAGE [COMMAND] [ARG...]
```

Dockeré•œåƒæœ‰ä¸¤ç§è¿è¡Œæ–¹å¼ï¼Œå³**äº¤äº’å¼**å’Œ**åå°æ¨¡å¼**

- äº¤äº’å¼
```bash
sudo docker run -it --rm --name hello ubuntu:18.04 /bin/echo "hello docker"
```

å„ä¸ªå‚æ•°è§£æï¼š
- -t: åœ¨æ–°å®¹å™¨å†…æŒ‡å®šä¸€ä¸ªä¼ªç»ˆç«¯æˆ–ç»ˆç«¯ã€‚
- -i: å…è®¸ä½ å¯¹å®¹å™¨å†…çš„æ ‡å‡†è¾“å…¥ (STDIN) è¿›è¡Œäº¤äº’ã€‚
- --rm: é€€å‡ºä¹‹åè‡ªåŠ¨åˆ é™¤å®¹å™¨ï¼ˆå¦åˆ™ï¼Œå®¹å™¨å®ä¾‹ä¼šæŒç»­å­˜åœ¨ï¼Œå¯ä»¥é‡æ–°è¿›å…¥ï¼‰ã€‚
- --name: ç»™å®¹å™¨å®ä¾‹æŒ‡å®šä¸€ä¸ªåå­—ï¼Œä¸å¯é‡å¤ã€‚

> æŒ‡å®š`-it`,ä¹Ÿå¯ä»¥é…åˆ `/bin/bash`å‘½ä»¤å¯ä»¥è¿›å…¥å®¹å™¨å†…éƒ¨ã€‚

- åå°æ¨¡å¼(-d)
```bash
sudo docker run -d ubuntu:15.10 /bin/sh -c "while true; do echo hello world; sleep 1; done"
```

-d: ä»¥åå°æ¨¡å¼è¿è¡Œå®¹å™¨ï¼Œè¿”å›ä¸€ä¸ªå®¹å™¨IDã€‚

## ä¸ƒã€Dockerå¸¸ç”¨å‘½ä»¤

```bash
# 1. åœ¨docker hubæœç´¢é•œåƒ 
docker search ubuntu

# 2. æŸ¥çœ‹æœ¬æœºå·²æœ‰çš„é•œåƒ
docker images

# 3. ä»docker hub æ‹‰å–é•œåƒ
docker pull centos

# 4. è¿è¡Œé•œåƒ
docker run -it --rm --name hello ubuntu:18.04 /bin/echo "hello docker"
docker run -d -p 8080:8080 --name tomcat daocloud.io/library/tomcat:8.5

# 5. æŸ¥çœ‹æ­£åœ¨è¿è¡Œçš„å®¹å™¨
docker ps

# 6. æŸ¥çœ‹æ‰€æœ‰å®¹å™¨
docker ps -a

# 7. è¿›å…¥åå°è¿è¡Œçš„å®¹å™¨
##ä½¿ç”¨attach
docker attach <names> æˆ–è€… docker attach <Container id>

##ä½¿ç”¨docker execå‘½ä»¤
docker exec -it <names> /bin/sh æˆ–è€… docker exec -it <Container id> /bin/sh

# 8. ä¿å­˜é•œåƒä¿®æ”¹ï¼Œå¹¶åˆ›å»ºæ–°çš„é•œåƒ
docker commit <Container id> duomics/myimg

# 9. åœç”¨æ‰€æœ‰å®¹å™¨
docker stop $(docker ps -q)

# 10. åˆ é™¤æ‰€æœ‰å®¹å™¨
docker rm $(docker ps -aq)
##ä¸€æ¡å‘½ä»¤åœç”¨å¹¶åˆ é™¤æ‰€æœ‰å®¹å™¨
docker stop $(docker ps -q) & docker rm $(docker ps -aq)

# 11. åˆ é™¤é•œåƒ
docker rmi <image id>

# 12. å‘å¸ƒè‡ªå·±çš„é•œåƒ
docker push duomics/myimg
```

## å…«ã€åˆ›å»ºè‡ªå·±çš„Dockeré•œåƒ
Dockeré•œåƒå¯ä»¥é€šè¿‡Dockerfileæ–‡ä»¶åˆ›å»º
> å‚è€ƒï¼š[Dockerfileæœ€ä½³å®è·µ](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/)
```bash
# syntax=docker/dockerfile:1
FROM golang:1.16-alpine AS build

# Install tools required for project
# Run `docker build --no-cache .` to update dependencies
RUN apk add --no-cache git
RUN go get github.com/golang/dep/cmd/dep

# Copy the entire project and build it
# This layer is rebuilt when a file changes in the project directory
COPY . /go/src/project/
RUN go build -o /bin/project

# This results in a single layer image
FROM scratch
COPY --from=build /bin/project /bin/project
ENTRYPOINT ["/bin/project"]
CMD ["--help"]
```

å„ä¸ªå‘½ä»¤è§£æï¼š
- FROMï¼šä½¿ç”¨å·²æœ‰çš„imageä½œä¸ºåŸºç¡€ï¼Œåˆ›å»ºæ–°çš„é•œåƒ
- COPYï¼šå°†æ–‡ä»¶æ‹·è´åˆ°å½“å‰ç›®å½•
- RUNï¼š è¿è¡ŒæŒ‡å®šå‘½ä»¤
- WORKDIRï¼š ç›¸å½“äºcd
- ENTRYPOINTï¼šå®¹å™¨è¿è¡Œçš„ç¨‹åºå…¥å£
- CMDï¼šé€šå¸¸ä¸ ENTRYPOINTè¿ç”¨ï¼Œç”¨æ¥æ·»åŠ ç¨‹åºè¿è¡Œçš„å‚æ•°ï¼Œä¸€ä¸ªDockerfile åªæœ‰æœ€åä¸€ä¸ªCMDèµ·ä½œç”¨

å…¶ä»–å‘½ä»¤ï¼š
- ENVï¼šç”¨äºç¯å¢ƒå˜é‡çš„è®¾ç½®
- ADDï¼šä¸COPYç±»ä¼¼
- USER: æŒ‡å®šä¸€ä¸ªérootçš„ç”¨æˆ·
- ...

## ä¹ã€Docker ä¸ Singularity
> [Singularityå‚è€ƒæ–‡æ¡£](https://sylabs.io/guides/3.8/user-guide/)

Singularityä¸Dockerç±»ä¼¼ï¼Œä¸”å®Œå…¨å…¼å®¹dockerçš„é•œåƒèµ„æºã€‚æ¯”å¦‚ï¼ŒSingularityä»docker hub æ‹‰å–ubuntué•œåƒï¼š
```bash
singularity pull docker://ubuntu
# 
# INFO:    Converting OCI blobs to SIF format
# INFO:    Starting build...
# ...
# INFO:    Creating SIF file...

# ç›´æ¥åœ¨å½“å‰è·¯å¾„ç”ŸæˆSIFæ–‡ä»¶ï¼š ubuntu_latest.sif
# 
```

## åã€å°†æœ¬åœ°dockeré•œåƒè½¬ä¸ºSigularityé•œåƒ

```bash
# 1.save dockeré•œåƒ ==> xxx.tar 
# docker save <docker-images-id> -o output.tar 
sudo docker save c49a84dae241 -o msfragger_v3.1.1.tar

# 2. å°†dockeré•œåƒå‹ç¼©åŒ…è½¬æ¢æˆsingularityé•œåƒæ–‡ä»¶
sudo singularity build msfragger_v3.1.1.sif docker-archive://msfragger_v3.1.1.tar

```

## å‚è€ƒæ–‡æ¡£
- [Dockerå®˜æ–¹æ–‡æ¡£](https://docs.docker.com/)
- [Dockerå…¥é—¨æ•™ç¨‹-é˜®ä¸€å³°](http://www.ruanyifeng.com/blog/2018/02/docker-tutorial.html)

